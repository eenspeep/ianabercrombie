<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DNGN</title>
  <link rel="icon" type="image/png" href="screamgnome.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@ruffle-rs/ruffle" defer></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }

    :root{
      --pad: clamp(10px, 2.2vmin, 16px);
      --gap: clamp(8px, 2vmin, 12px);
      --title-h: clamp(28px, 4.2vmin, 36px);
      --menu-h:  clamp(26px, 3.8vmin, 32px);
      --status-h: clamp(26px, 3.8vmin, 32px);
      --sidebar-w: clamp(160px, 24vw, 220px);
    }

    @keyframes wiggle {
      0%   { transform: rotate(0deg) translateY(0); }
      25%  { transform: rotate(-4deg) translateY(-1px); }
      50%  { transform: rotate(0deg) translateY(0); }
      75%  { transform: rotate(4deg) translateY(-1px); }
      100% { transform: rotate(0deg) translateY(0); }
    }
    .wiggle { display:inline-block; transform-origin:50% 75%; animation: wiggle .6s ease-in-out infinite; }

    @keyframes wave {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-0.25em); }
      100% { transform: translateY(0); }
    }
    .wavy { display:inline-block; white-space: pre-wrap; }
    .wavy .wchar { display:inline-block; animation: wave 1.8s ease-in-out infinite; animation-delay: calc(var(--i) * 0.06s); }

    @keyframes shine {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .shiny {
      display:inline-block;
      color: transparent;
      background: linear-gradient(90deg, currentColor 0 30%, #ffffff 50%, currentColor 70% 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      animation: shine 2.2s linear infinite;
    }

    @media (prefers-reduced-motion: reduce) {
      .wiggle { animation: none !important; }
      .wavy .wchar { animation: none !important; }
      .shiny { animation: none !important; background: none; color: inherit; }
    }

    body {
      background: linear-gradient(to bottom, #ffffff 0%, #ffffff 95%, #000000 100%);
      font-family: "Courier New", monospace;
      color: #000;
      overflow: hidden;
      position: relative;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .site-container {
      position: absolute;
      inset: 20px;
      background: #fff;
      height: calc(100svh - 40px);
      height: calc(100dvh - 40px);
      border: 1px solid #000;
      box-shadow: 6px 6px 12px rgba(0,0,0,.2);
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      z-index: 2;
      min-width: 0;
      min-height: 0;
    }

    .font-press {
      font-family: "Press Start 2P", "Courier New", monospace;
      letter-spacing: 0.02em;
      line-height: 1.4;
    }
    .fs-90  { font-size: 0.9em; }
    .fs-110 { font-size: 1.1em; }
    .fs-130 { font-size: 1.3em; }

    .sidebar {
      background: #f3f3f3;
      border-right: 1px solid #000;
      display: grid;
      grid-template-rows: auto auto 1fr;
      padding: var(--pad);
      gap: var(--gap);
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }

    .photo-frame {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset -2px -2px 0 #000, inset 2px 2px 0 #fff;
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
    }
    #profile-pic {
      width: 100%; height: 100%;
      object-fit: cover; cursor: pointer;
      position: relative; z-index: 1;
      display: block;
      -webkit-user-drag: none; user-select: none;
    }
    #explosion {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      display: none; pointer-events: none;
      z-index: 2;
    }
    .mini-caption {
      text-align: center;
      font-size: clamp(.85rem, 1.6vmin, .95rem);
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #fff;
      padding: 8px 10px;
      transition: opacity .15s ease;
    }

    .btn-95 {
      display: block;
      text-decoration: none;
      color: #000;
      background: #e9e9e9;
      border: 1px solid #000;
      box-shadow: inset -2px -2px 0 #fff, inset 2px 2px 0 #000;
      padding: 10px 12px;
      text-align: left;
      transition: transform .05s ease;
      user-select: none;
      font-size: clamp(.9rem, 1.8vmin, 1rem);
    }
    .btn-95:active {
      transform: translate(1px,1px);
      box-shadow: inset -2px -2px 0 #000, inset 2px 2px 0 #fff;
      background: #dcdcdc;
    }
    .nav { display: grid; gap: 8px; align-content: start; }

    .topbar-mobile { display: none; }
    .topbar-inner {
      background: #e0e0e0; border-bottom: 1px solid #000;
      padding: 6px 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .brand95 { font-weight: bold; }
    .menu95 { border: 1px solid #000; background: #e9e9e9; padding: 6px 10px; }
    .menu95:active { transform: translate(1px,1px); background: #dcdcdc; }
    .dropdown95 {
      position: absolute; top: 100%; right: 8px;
      border: 1px solid #000; background: #fff;
      display: none; min-width: 160px;
      z-index: 10;
    }
    .dropdown95 a { display: block; padding: 8px 10px; color: #000; text-decoration: none; border-bottom: 1px solid #000; }
    .dropdown95 a:last-child { border-bottom: none; }
    .dropdown95 a:hover { background: #efefef; }

    .main {
      overflow: hidden;
      padding: clamp(10px, 2.2vmin, 24px);
      display: grid; place-items: center;
      min-width: 0; min-height: 0;
    }
    .win95-window {
      width: min(960px, 100%);
      background: #fff;
      border: 2px solid #000;
      box-shadow: inset -2px -2px 0 #000, inset 2px 2px 0 #fff;
      display: grid;
      grid-template-rows: var(--title-h) var(--menu-h) 1fr var(--status-h);
      height: 100%; max-height: 100%;
      min-width: 0; min-height: 0;
    }
    .titlebar {
      background: #e0e0e0;
      border-bottom: 1px solid #000;
      padding: 0 10px;
      display: flex; justify-content: space-between; align-items: center;
      gap: 8px;
    }
    .titlebar .title { font-weight: bold; }
    .controls { display: flex; gap: 6px; }
    .ctl {
      width: 18px; height: 18px;
      border: 1px solid #000; background: #fff;
      display: grid; place-items: center; font-size: 12px; line-height: 1;
    }
    .ctl:active { transform: translate(1px,1px); }

    .menubar {
      background: #f7f7f7;
      border-bottom: 1px solid #000;
      padding: 0 10px;
      display: flex; gap: 16px; align-items: center;
      font-size: 0.9rem;
      user-select: none;
    }

    .menu-item {
      position: relative;
      padding: 0 4px;
      cursor: default;
    }
    .menu-label {
      padding: 2px 4px;
    }
    .menu-item.menu-open .menu-label,
    .menu-item:hover .menu-label {
      background: #000;
      color: #fff;
    }
    .menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 180px;
      background: #f7f7f7;
      border: 1px solid #000;
      box-shadow: 3px 3px 6px rgba(0,0,0,0.25);
      display: none;
      z-index: 20;
    }
    .menu-item.menu-open .menu-dropdown {
      display: block;
    }
    .menu-dropdown button,
    .menu-dropdown a,
    .menu-dropdown label {
      display: block;
      width: 100%;
      padding: 4px 10px;
      border: none;
      background: none;
      text-align: left;
      font: inherit;
      color: #000;
      text-decoration: none;
      cursor: default;
    }
    .menu-dropdown button:hover,
    .menu-dropdown a:hover {
      background: #000;
      color: #fff;
    }
    .menu-separator {
      border-top: 1px solid #000;
      margin: 4px 0;
    }
    .menu-go {
      padding: 4px 10px;
    }
    .menu-go label {
      padding: 0;
    }
    #menu-page-input {
      width: 64px;
      margin-top: 2px;
      padding: 2px 4px;
      border: 1px solid #000;
      font: inherit;
      background: #fff;
    }

    .window-body {
      padding: 16px;
      overflow: hidden;
      display: grid;
      min-height: 0;
    }

    .comic-container {
      position: relative;
      z-index: 1;
      height: 100%;
      border: 1px solid black;
      padding: 20px;
      background:
        linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)) padding-box,
        url("bricks.png") padding-box;
      background-repeat: no-repeat, repeat;
      background-position: 0 0, 0 0;
      background-origin: padding-box, padding-box;
      background-clip: padding-box, padding-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-y: auto;
      min-height: 0;
      gap: 20px;
    }
    .comic-container::-webkit-scrollbar { width: 3px; background: transparent; }
    .comic-container::-webkit-scrollbar-track { background: transparent; }

    .comic-title {
      display: none;
      font-size: clamp(1.1rem, 2.6vmin, 1.3rem);
      font-weight: bold;
      font-family: "Courier New", monospace;
      color: #000;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      overflow: break-word;
      text-align: center;
      margin-bottom: 6px;
      max-width: 82%;
      padding: 6px 10px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset -2px -2px 0 #000, inset 2px 2px 0 #fff;
    }
    .comic-title .cursor {
      display: inline-block;
      width: 10px;
      background: currentColor;
      animation: blink 1s steps(2, start) infinite;
      vertical-align: bottom;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      50.01%, 100% { opacity: 0; }
    }

    .panel-area{
      width: 100%;
      display: grid;
      grid-auto-rows: auto;
      gap: 16px;
      place-items: center;
    }

    .comic-panel {
      position: relative; z-index: 1;
      width: 82%; max-width: 720px;
      aspect-ratio: 4 / 3;
      background-color: #ccc; background-size: cover; background-position: center;
      border: 1px solid black;
    }

    .comic-panel.flash-panel {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
    }

    .comic-panel.flash-panel ruffle-player {
      width: 100%;
      height: 100%;
    }

    .comic-panel.tall-45{ aspect-ratio: 4 / 5; }
    .comic-panel.tall-23{ aspect-ratio: 2 / 3; }
    .comic-panel.tall-87{ aspect-ratio: 8 / 7; }

    .panel-area.columns-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .panel-area.columns-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

    .panel-area.columns-2 .comic-panel,
    .panel-area.columns-3 .comic-panel{
      width: 100%;
      max-width: 720px;
    }

    .comic-text {
      position: relative; z-index: 1;
      font-size: clamp(1rem, 2.4vmin, 1.1rem);
      line-height: 1.6; letter-spacing: 0.5px;
      text-align: center; white-space: pre-wrap;
      border: 1px solid black; padding: 10px 15px; background: #f9f9f9;
      max-width: 82%;
      box-shadow: 3px 3px 6px rgba(0,0,0,0.1);
      overflow-wrap: anywhere;
      word-break: break-word;
      overflow: break-word;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      margin-left: 8px;
      font-size: .85em;
      line-height: 1.2;
      border: 1px solid #000;
      background: #e9e9e9;
      box-shadow: inset -2px -2px 0 #fff, inset 2px 2px 0 #000;
      vertical-align: middle;
      user-select: none;
    }

    .flairs{
      display:inline-flex;
      gap:6px;
      margin-left:8px;
      vertical-align:middle;
    }
    .flair{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      font-size:.85em;
      line-height:1.2;
      border:1px solid #000;
      box-shadow: inset -2px -2px 0 #fff, inset 2px 2px 0 #000;
      background:#ffffff;
      user-select:none;
    }
    .flair--author    { background:#f3f3f3; }
    .flair--spectator { background:#e9f0ff; }
    .flair--agency    { background:#b9ff66; }

    .button-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
    }

    .button-bar a,
    .button-bar input[type="number"],
    .button-bar button {
      padding: 10px 14px;
      border: 1px solid black;
      text-decoration: none;
      color: black;
      background-color: #fff;
      transition: background-color 0.2s ease, transform 0.2s ease;
      font-family: "Courier New", monospace;
      cursor: pointer;
    }

    .button-bar a:hover,
    .button-bar button:hover {
      background-color: #ddd;
      transform: translateY(-2px);
    }

    .button-bar input[type="number"] {
      width: 64px;
      text-align: center;
    }

    .statusbar {
      background: #f7f7f7;
      border-top: 1px solid #000;
      padding: 0 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: clamp(.8rem, 1.7vmin, .95rem);
      min-height: var(--status-h);
    }
    .sb-left, .sb-center, .sb-right { white-space: nowrap; }

    @media (hover: none), (max-width: 640px) {
      .sidebar { display: none !important; }
      .site-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .topbar-mobile { display: block; position: relative; z-index: 3; }
      .statusbar { justify-content: center; }
      .sb-left, .sb-right { display: none !important; }
      .sb-center { text-align: center; }
    }

    .btn-95.small {
      display: inline-block;
      padding: 4px 8px;
      font-size: 0.8rem;
      margin-left: 8px;
      vertical-align: middle;
    }

    .cursor-shadow {
      position: fixed;
      width: 18px; height: 18px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><polygon points="0,0 0,32 8,24 14,30 16,28 10,22 18,22" fill="black"/></svg>') no-repeat center center/contain;
      opacity: .25; pointer-events: none; z-index: 10000;
    }
    @media (hover: none), (max-width: 640px) { .cursor-shadow { display: none !important; } }

    @media (max-width: 720px){
      :root{ --sidebar-w: clamp(140px, 30vw, 180px); }
    }

    .gate-overlay{
      position: fixed; inset: 0;
      background: rgba(255,255,255,.92);
      display: flex; align-items: center; justify-content: center;
      z-index: 100000;
      padding: 16px;
    }
    .gate-window{
      width: min(420px, 100%);
      background: #fff;
      border: 2px solid #000;
      box-shadow: inset -2px -2px 0 #000, inset 2px 2px 0 #fff, 6px 6px 12px rgba(0,0,0,.2);
      display: grid; grid-template-rows: auto 1fr auto auto; gap: 10px;
    }
    .gate-window .titlebar{
      background: #e0e0e0; border-bottom: 1px solid #000;
      padding: 6px 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .gate-window .titlebar .title{ font-weight: bold; }
    .gate-body{
      padding: 12px 14px;
      border-bottom: 1px solid #000;
      line-height: 1.5;
    }
    .gate-actions{
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
      padding: 0 14px 4px;
    }
    .gate-actions .btn-95{ text-align: center; }
    .gate-remember{ display: block; padding: 0 14px 14px; font-size: .95rem; }
    @media (max-width: 480px){ .gate-actions{ grid-template-columns: 1fr; } }
		/* CHATLOG CONTAINER â€“ wrapper, no box of its own */
		.chatlog {
		  margin: 0 auto;
		  max-width: 82%;
		  text-align: center;
		  border: none;
		  background: transparent;
		  box-shadow: none;
		}

		button.chatlog-toggle:active {
		  transform: translate(1px,1px);
		  box-shadow:
			inset -2px -2px 0 #000,
			inset 2px 2px 0 #fff;
		  background: #dcdcdc;
		}

		/* The label itself */
		.chatlog-label {
		  display: block;
		  text-align: center;
		  white-space: nowrap;      /* keeps STONELOG snug in the middle */
		}


		/* Collapsed body */
		.chatlog.minimized .chatlog-body {
		  display: none;
		}

		/* When NOT minimized, show the box ONLY around the chat body */
		.chatlog:not(.minimized) .chatlog-body {
		  border: 1px solid #000;
		  background: #fff;
		  box-shadow:
			inset -2px -2px 0 #000,
			inset 2px 2px 0 #fff,
			3px 3px 6px rgba(0,0,0,.08);
		  margin-top: 4px;   /* tiny gap between button and box */
		}


		/* Inside of the chat â€“ tight top/bottom spacing */
		.chatlog-body {
		  max-height: 40vh;
		  overflow: auto;
		  padding: 0 5px;        /* no top/bottom padding, only sides */
		  line-height: 1.6;
		  text-align: left;
		  margin: 0;
		}

		/* Each chat line â€“ NO extra margin between lines */
		.chatline {
		  margin: 0;
		}

		/* Keep name + text on the same line */
		.chat-name,
		.chat-msg {
		  display: inline;
		  text-align: left;
		  white-space: pre-wrap;
		}

		/* WHOLE LINE COLORED PER CHARACTER */
		.chat-FTR .chat-name,
		.chat-FTR .chat-msg {
		  color: #ee2d36;
		}
		.chat-WZD .chat-name,
		.chat-WZD .chat-msg {
		  color: #4d74a8;
		}
		.chat-THF .chat-name,
		.chat-THF .chat-msg {
		  color: #1b8d3d;
		}

		/* Fallback if you add more speakers */
		.chatline .chat-name {
		  font-weight: bold;
		}

		/* Tiny, centered "header" button like a pesterlog title */
		button.chatlog-toggle {
		  all: unset;                /* wipe all inherited/UA/button styles */
		  box-sizing: border-box;

		  display: inline-block;     /* hugs the text, not full width */
		  margin: 0 auto;
		  padding: 0 8px;

		  font-family: "Courier New", monospace;
		  font-size: 0.8rem;
		  line-height: 1.2;
		  text-align: center;        /* center the label inside the button */

		  cursor: pointer;
		  user-select: none;

		  border: 1px solid #000;
		  background: #e0e0e0;
		  box-shadow:
			inset -2px -2px 0 #fff,
			inset 2px 2px 0 #000;
		}

		button.chatlog-toggle:active {
		  transform: translate(1px,1px);
		  box-shadow:
			inset -2px -2px 0 #000,
			inset 2px 2px 0 #fff;
		  background: #dcdcdc;
		}

		button.chatlog-toggle:focus-visible {
		  outline: 1px dotted #000;
		  outline-offset: 2px;
		}

		/* Remove extra space above the chatlog button */
		.chatlog {
		  margin-top: 0 !important;
		}

		/* Remove margins on ANY element directly before a chatlog */
		.comic-text > *:has(+ .chatlog),
		.comic-text > *:has(+ .chatlog ~ *),
		.comic-text > * + .chatlog {
		  margin-top: 0 !important;
		  padding-top: 0 !important;
		}

		/* Remove default block spacing INSIDE the chatlog wrapper */
		.chatlog-toggle {
		  margin-top: 0 !important;
		  margin-bottom: 0 !important;
		}

		/* Tighten the box itself when open */
		.chatlog-body {
		  margin-top: 0 !important;
		  margin-bottom: 0 !important;
		}
		
		/* Tighten paragraph spacing inside captions */
		.comic-text p {
		  margin-top: 0;
		  margin-bottom: 0.25em;  /* small gap between lines, not a huge chasm */
		}

		/* If a paragraph is directly followed by a chatlog, remove that extra bottom gap */
		.comic-text p + .chatlog {
		  margin-top: 0;
		}
		
		





    @media (max-width: 640px){
      .chatlog-body { max-height: 50vh; }
    }

    .gnome-wrapper {
      position: fixed;
      bottom: 10px;
      pointer-events: none;
      z-index: 9999;
    }
    .gnome, .gnome-boom, .gnome-hitbox {
      user-select: none; -webkit-user-drag: none; -webkit-touch-callout: none;
    }
    .gnome {
      height: clamp(52px, 7.2vmin, 68px);
      transform: scaleX(1);
      pointer-events: auto;
      cursor: pointer;
    }
    .gnome-boom { position: absolute; left: -16px; bottom: -16px; width: 100px; display: none; pointer-events: none; }
    .gnome-hitbox { position: absolute; left: -10px; bottom: -6px; width: 88px; height: 80px; pointer-events: auto; cursor: pointer; background: transparent; }

    @keyframes gnome-run-left {
      0%   { transform: translateX(-60px); }
      100% { transform: translateX(calc(100vw + 60px)); }
    }
    @keyframes gnome-run-right {
      0%   { transform: translateX(calc(100vw + 60px)); }
      100% { transform: translateX(-60px); }
    }
  </style>
</head>
<body>
  <div class="cursor-shadow" id="cursor-shadow"></div>

  <div id="epilepsy-gate" class="gate-overlay" role="dialog" aria-modal="true" aria-labelledby="gate-title">
    <div class="gate-window">
      <div class="titlebar">
        <div class="title" id="gate-title">WARNING.EXE</div>
      </div>
      <div class="gate-body">
        This comic may contain <b>flashing images</b> that could trigger seizures for people with photosensitive epilepsy.
        Proceed with caution.
      </div>
      <div class="gate-actions">
        <button id="gate-enter" class="btn-95">ENTER DNGN</button>
        <a id="gate-back" class="btn-95" href="index.html" role="button">GO BACK</a>
      </div>
      <label class="gate-remember">
        <input type="checkbox" id="gate-remember">
        Donâ€™t show again
      </label>
    </div>
  </div>

  <div class="site-container">
    <div class="topbar-mobile">
      <div class="topbar-inner">
        <div class="brand95">SPEEP</div>
        <button class="menu95" id="menuBtn" type="button" aria-expanded="false">Menu â–¾</button>
        <div class="dropdown95" id="dropdown">
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
          <a href="comic.html">DNGN</a>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="photo-frame" id="photo-frame">
        <img src="Icons/icon1.png" alt="Profile or Logo" id="profile-pic" />
        <img src="Animations/explosion.gif" alt="Explosion" id="explosion" />
        <audio id="boom" src="Animations/explosion.mp3"></audio>
      </div>
      <div class="mini-caption" id="mini-caption">Writer, Editor, Reader</div>

      <nav class="nav">
        <a class="btn-95" href="index.html">Home</a>
        <a class="btn-95" href="about.html">About</a>
        <a class="btn-95" href="contact.html">Contact</a>
        <a class="btn-95" href="comic.html">DNGN</a>
      </nav>
    </aside>

    <main class="main">
      <section class="win95-window" role="group" aria-label="DNGN Window">
        <div class="titlebar">
          <div class="title">DNGN.TXT</div>
          <div class="controls">
            <div class="ctl" title="Minimize">_</div>
            <div class="ctl" title="Maximize">â–¡</div>
            <div class="ctl" title="Close">Ã—</div>
          </div>
        </div>

        <div class="menubar">
          <div class="menu-item" data-menu="file">
            <span class="menu-label">File</span>
            <div class="menu-dropdown" data-menu-panel="file">
              <button type="button" data-action="save">Save Game</button>
              <button type="button" data-action="load">Load Game</button>
              <button type="button" data-action="submit">Submit Command</button>
            </div>
          </div>
          <div class="menu-item" data-menu="edit">
            <span class="menu-label">Edit</span>
            <div class="menu-dropdown" data-menu-panel="edit">
              <button type="button" data-nav="next">Next Page</button>
              <button type="button" data-nav="prev">Previous Page</button>
              <button type="button" data-nav="latest">Latest</button>
              <button type="button" data-nav="first">First</button>
              <div class="menu-separator"></div>
              <div class="menu-go">
                <label for="menu-page-input">Go to page:</label>
                <input type="number" id="menu-page-input" min="1" />
              </div>
            </div>
          </div>
          <div class="menu-item" data-menu="view">
            <span class="menu-label">View</span>
            <div class="menu-dropdown" data-menu-panel="view">
              <button type="button" data-view="archival">ARCHIVAL MODE (WIP)</button>
            </div>
          </div>
          <div class="menu-item" data-menu="help">
            <span class="menu-label">Help</span>
            <div class="menu-dropdown" data-menu-panel="help">
              <a href="about.html">ABOUT</a>
              <button type="button" data-help="guide">COMIC GUIDE (WIP)</button>
            </div>
          </div>
        </div>

        <div class="window-body">
          <div class="comic-container">
            <div class="comic-title" id="command-title"></div>
            <div id="panel-area" class="panel-area">
              <div class="comic-panel" id="panel"></div>
            </div>
            <div class="comic-text" id="caption"></div>

            <div class="button-bar">
              <a id="first" href="#" class="btn-95">First</a>
              <a id="prev" href="#" class="btn-95">Previous</a>
              <input type="number" id="page-jump" min="1" placeholder="Page #" />
              <a id="next" href="#" class="btn-95">Next</a>
              <a id="latest" href="#" class="btn-95">Latest</a>
              <button id="save-btn" class="btn-95">Save Game</button>
              <button id="load-btn" class="btn-95">Load Game</button>
            </div>
          </div>
        </div>

        <div class="statusbar">
          <span class="sb-left">DNGN is loadingâ€¦</span>
          <span class="sb-center"><strong>GNOMES CAUGHT:</strong> <span id="gnome-count">0</span></span>
          <span class="sb-right">Â© 1998 SPEEP</span>
          <a id="submit-link" href="submit.html" class="btn-95 small">SUBMIT</a>
          <a href="https://ko-fi.com/speep" target="_blank" class="btn-95 small">SUPPORT DNGN</a>
          <a href="https://discord.gg/UvgGEp2pFq" target="_blank" class="btn-95 small">JOIN DISCORD</a>
        </div>
      </section>
    </main>
  </div>

  <div id="gnome-layer"></div>

  <script>
    "use strict";

    /* ===== Epilepsy gate ===== */
    (function(){
      const gate = document.getElementById('epilepsy-gate');
      if (!gate) return;
      const enter = document.getElementById('gate-enter');
      const remember = document.getElementById('gate-remember');
      const KEY = 'dngn_epilepsy_ok';

      try {
        if (localStorage.getItem(KEY) === '1') {
          gate.style.display = 'none';
        }
      } catch {}

      function accept(){
        if (remember && remember.checked) {
          try { localStorage.setItem(KEY, '1'); } catch {}
        }
        gate.style.display = 'none';
      }
      enter.addEventListener('click', accept);

      gate.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const f = gate.querySelectorAll('button, [href], input');
        if (!f.length) return;
        const first = f[0], last = f[f.length - 1];
        if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
      });

      if (gate.style.display !== 'none') {
        setTimeout(() => enter.focus(), 0);
      }
    })();

    /* ===== Mobile top menu ===== */
    (function(){
      const btn = document.getElementById('menuBtn');
      const dd  = document.getElementById('dropdown');
      if (!btn || !dd) return;

      btn.addEventListener('click', e=>{
        const open = dd.style.display==='block';
        dd.style.display = open ? 'none' : 'block';
        btn.setAttribute('aria-expanded', String(!open));
        e.stopPropagation();
      });
      document.addEventListener('click', ()=>{ dd.style.display='none'; btn.setAttribute('aria-expanded','false'); });
    })();

    /* ===== Cursor shadow ===== */
    (function(){
      const isTouchLike = window.matchMedia('(hover: none)').matches || 'ontouchstart' in window;
      const cursorShadow = document.getElementById('cursor-shadow');
      if (!isTouchLike && cursorShadow) {
        document.addEventListener('mousemove', e => {
          cursorShadow.style.left = `${e.clientX + 3}px`;
          cursorShadow.style.top  = `${e.clientY + 3}px`;
        });
      }
    })();

    /* ===== Sidebar photo explosion ===== */
    (function(){
      const images = ["Icons/icon1.png","Icons/icon2.png","Icons/icon3.png","Icons/icon4.png"];
      const titles = {
        "icon1.png": "Writer, Editor, Reader",
        "icon2.png": "Writer, Editor, Cyclops",
        "icon3.png": "Writer, Editor, Freak of Nature",
        "icon4.png": "Writer, Editor, Scallawag"
      };
      const pic = document.getElementById('profile-pic');
      const explosion = document.getElementById('explosion');
      const boom = document.getElementById('boom');
      const frame = document.getElementById('photo-frame');
      const miniCaption = document.getElementById('mini-caption');

      function filenameFromSrc(src) {
        return (src.split('/').pop() || "").split('?')[0].split('#')[0].toLowerCase();
      }
      function setCaptionForFilename(fileKey) {
        const text = titles[fileKey]; if (!text) return;
        miniCaption.style.opacity = '0';
        setTimeout(() => {
          miniCaption.textContent = text;
          miniCaption.style.opacity = '1';
        }, 80);
      }
      function initCaption() { setCaptionForFilename(filenameFromSrc(pic.src)); }
      if (pic.complete) initCaption(); else pic.addEventListener('load', initCaption, { once: true });

      function playExplosionOnFrame() {
        const base = explosion.getAttribute('src').split('?')[0];
        explosion.setAttribute('src', `${base}?t=${Date.now()}`);
        explosion.style.display = 'block';
      }
      function hideExplosionOnFrame() { explosion.style.display = 'none'; }

      pic.addEventListener('click', () => {
        playExplosionOnFrame();
        try { boom.volume = 0.4; boom.currentTime = 0; boom.play(); } catch {}
        frame.classList.add('screen-shake');

        setTimeout(() => {
          hideExplosionOnFrame();
          frame.classList.remove('screen-shake');
          const currentKey = filenameFromSrc(pic.src);
          let next;
          do { next = images[Math.floor(Math.random() * images.length)]; }
          while (filenameFromSrc(next) === currentKey);
          setCaptionForFilename(filenameFromSrc(next));
          pic.src = next;
        }, 300);
      });
    })();

    /* ===== Gnome counter ===== */
    (function(){
      const countEl = document.getElementById('gnome-count');
      const COUNT_NS = 'speep.me';
      const COUNT_KEY = 'gnomes_caught';
      const LOCAL_MIRROR = 'gnomeCountMirror';

      function setCount(n){ countEl.textContent = n; }

      async function initCount(){
        try {
          const r = await fetch(`https://api.countapi.xyz/get/${COUNT_NS}/${COUNT_KEY}`);
          const d = await r.json();
          if (typeof d.value === 'number') {
            setCount(d.value);
            localStorage.setItem(LOCAL_MIRROR, String(d.value));
            return;
          }
          throw new Error();
        } catch {
          const n = Number(localStorage.getItem(LOCAL_MIRROR) || 0);
          setCount(n);
        }
      }
      initCount();

      window.__incrementGnomeCount = async function(){
        try {
          const r = await fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/${COUNT_KEY}`);
          const d = await r.json();
          if (typeof d.value === 'number') {
            setCount(d.value);
            localStorage.setItem(LOCAL_MIRROR, String(d.value));
            return;
          }
          throw new Error();
        } catch {
          const n = Number(localStorage.getItem(LOCAL_MIRROR) || 0) + 1;
          localStorage.setItem(LOCAL_MIRROR, String(n));
          setCount(n);
        }
      };
    })();

    /* ===== Gnome spawner ===== */
    (function(){
      const gnomeLayer = document.getElementById('gnome-layer');

      const SPEED_MIN = 3.5;
      const SPEED_MAX = 9.0;
      const BATCH_MIN = 1;
      const BATCH_MAX = 3;
      const BATCH_DELAY_MIN = 15000;
      const BATCH_DELAY_MAX = 45000;

      function rand(min, max){ return min + Math.random() * (max - min); }
      function randInt(min, max){ return Math.floor(rand(min, max + 1)); }
      function randDuration(min = SPEED_MIN, max = SPEED_MAX){ return rand(min, max); }

      function bindExplodeTarget(el, handler){
        ['pointerdown','mousedown','touchstart'].forEach(type => {
          el.addEventListener(type, (e) => {
            e.preventDefault();
            e.stopPropagation();
            handler();
          }, { passive: false });
        });
        el.addEventListener('dragstart', (e) => { e.preventDefault(); return false; });
      }

      function spawnGnome(side){
        const wrap = document.createElement('div');
        wrap.className = 'gnome-wrapper';

        const hit = document.createElement('div');
        hit.className = 'gnome-hitbox';

        const img = document.createElement('img');
        img.className = 'gnome';
        img.src = 'Animations/gnome.gif';
        img.alt = 'Running gnome';
        img.setAttribute('draggable','false');

        const boomImg = document.createElement('img');
        boomImg.className = 'gnome-boom';
        boomImg.src = 'Animations/explosion.gif';
        boomImg.alt = 'Boom';
        boomImg.setAttribute('draggable','false');

        img.style.transform = (side === 'left') ? 'scaleX(-1)' : 'scaleX(1)';

        wrap.style.animation = 'none';
        wrap.style.transform = (side === 'left')
          ? 'translateX(-60px)'
          : 'translateX(calc(100vw + 60px))';

        wrap.appendChild(hit);
        wrap.appendChild(img);
        wrap.appendChild(boomImg);
        gnomeLayer.appendChild(wrap);

        let exploded = false;

        function explode(){
          if (exploded) return;
          exploded = true;

          const matrix = getComputedStyle(wrap).transform;
          wrap.style.animation = 'none';
          wrap.style.transform = matrix !== 'none' ? matrix : wrap.style.transform;

          img.style.visibility = 'hidden';
          const base = boomImg.getAttribute('src').split('?')[0];
          boomImg.setAttribute('src', `${base}?uid=${crypto.randomUUID()}`);
          boomImg.style.display = 'block';

          try {
            const a = new Audio(document.getElementById('boom').src);
            a.volume = 0.5;
            a.play().catch(()=>{});
          } catch {}

          window.__incrementGnomeCount && window.__incrementGnomeCount();

          setTimeout(() => wrap.remove(), 750);
        }

        bindExplodeTarget(img, explode);
        bindExplodeTarget(hit, explode);

        const duration = randDuration();
        requestAnimationFrame(() => {
          wrap.style.animation = (side === 'left' ? 'gnome-run-left' : 'gnome-run-right') + ` ${duration}s linear forwards`;
        });

        wrap.addEventListener('animationend', () => { if (!exploded) wrap.remove(); });
      }

      function spawnBatch(){
        const n = randInt(BATCH_MIN, BATCH_MAX);
        for (let i = 0; i < n; i++){
          const side = (Math.random() < 0.5) ? 'left' : 'right';
          const stagger = Math.random() * 400;
          setTimeout(() => spawnGnome(side), stagger);
        }
      }

      function loopBatches(){
        const delay = rand(BATCH_DELAY_MIN, BATCH_DELAY_MAX);
        setTimeout(() => { spawnBatch(); loopBatches(); }, delay);
      }

      setTimeout(() => { spawnBatch(); loopBatches(); }, rand(BATCH_DELAY_MIN, BATCH_DELAY_MAX));
    })();

    (function(){
      const totalPages = 133;
      const captions = {
        1: { text: `Before you stands a bridge into darkness. Across the bridge, the DNGN. Your journey begins here. Humble. Unencumbered. Fastidious. Forthright? Brave... wait a second. Who is that?` },
        2: { text: `Hold on. Why don't we move some things out of the way?` },
        3: { text: `Let's get this fellow situated, why don't we?` },
        4: { text: `I'm sorry. It seems I was woefully unprepared for guests. Especially humble, unencumbered, fastidious, forthright, brave guests. Guests such as yourself. Allow me to put things in their places for this fellow's introduction.` },
        5: { text: `This is <b>FTR.</b> <br> <b>FTR</b> has six <b>CORE STATISTICS</b>.` },
        6: { text: `Let's see some more information about <b>FTR</b> before we place his <b>CORE STATISTICS</b>.` },
        7: { text: `If you just. Yeah. Just. Right there. That's better. Much better.` },
        8: { text: `It looks like <b>FTR</b>'s level is populating now. One must wonder how many points he has to allocate!` },
        9: { text: `Oh.` },
        10:{ text: `That's not great. <b>FTR</b> was supposed to start with a level, and points to allocate. Something must have gone wrong with your installation of DNGN.` },
        11:{ text: `Oh, but wait! What divine intelligence, perchance, might such a ghastly, gorgeous, gleaming glow expose?` },
        12:{ text: `<b>FTR</b> looks upon his saving grace with oppressive awe.` },
        13:{ text: `A ~Will-O'-The-Wisp~ has arrived! <b>FTR</b> can consume its essence for experience points to allocate.` },
        14:{ text: `<b>FTR</b>! Hop to, lad! You must defeat that fell spirit and claim your reward! Lest ye be ~powerless~!` },
        15:{ text: `Atta boy! Give 'em what-for!` },
        16:{ text: `Come on, <b>FTR</b>. You're going to have to try harder than this.` },
        17:{ text: `It looks like <b>FTR</b> doesn't know what to do. Why don't <u>you</u> <a href="submit.html?page=17">help him out?</a>` },
        18:{ text: `Yeah. I don't know if that will work. Could <u>you</u> be more specific? Help our lad out.`, title: `>FTR: DO SOMETHING ELSE`, source: `user`},
        19:{ text: `Apparently <b>FTR</b> has, like, a million weapons! Who would have thought!`, title: `>FTR: USE YOUR INVENTORY` },
        20:{ text: `Jesus christ that's a lot of weapons. Why don't you sort by <i>LEVEL-APPROPRIATE</i> instead.` },
        21:{ text: `Okay. A little disappointing, but I'm sure <b>FTR</b> will make do.` },
        22:{ text: `Excellently done! Now, <b>FTR</b>, do your worst!`, title: `>FTR: SELECT RUSTY SWORD` },
        23:{ text: `See, that's not typically what you do with these sorts of items. But, okay, I guess.`, title: `>FTR: KICK`, source: `user`},
        24:{ text: `Look at that sucker go.`},
        25:{ text: `That was close! Phew.`},
        26:{ text: `<b>FTR</b> is now scrounging around for bugs and worms and shit. Great.`, title: `>FTR: EAT`, source: `user`},
        27:{ text: `<b>FTR</b> doesn't have access to any firearms, so instead, he dreams beautiful, violent dreams. Gosh, all <b>FTR</b>s seem to really love weapons.`, title: `>FTR: SHOOT HIM WITH GUN`, source: `user`},
        28:{ text: `~AAAAAAAH!~ Oh, <b>FTR</b>, you even scared me!`, title: `>FTR: SCREAM`, source: `user`},
        29:{ text: `The ~Will-O'-The-Wisp~ screams back! It had no effect! <b>FTR</b>, do something! (Remember, <u>you</u> can always hit the SUBMIT button below to help <b>FTR</b> out!)`},
        30:{ text: `<b>FTR</b> dies. And that worm from before is <i>so</i> sad.`, title: `>FTR: DIE`, source: `user`},
        31:{ text: `Is this what <i>you</i> wanted?`},
        32:{ text: `That's enough of that.`},
        33:{ text: `I said that's enough of that.`, title: `>FTR: SLUT OUT`, source: `user`},
        34:{ text: `Well, to each their own I suppose. <b>FTR</b> looks very beautiful skanking out for us, or whatever it is that you asked him to do. Good for him. The only thing I am judgmental of is your inability to focus on the task at hand!`, title: `>FTR: SLUT OUT`, source: `user`},
        35:{ text: `<i>Finally.</i>`, title: `>FTR: FOCUS ON THE TASK AT HAND`},
        36:{ text: `<b>FTR</b> is trying to pull the RUSTY SWORD out, but it's stuck!`},
        37:{ text: `<b>FTR</b> is probably saying, like, "hrrggghhhhhhhffffffffffffffrrrrrrffgggggggggfhhhh" oh look he got it!`},
        38:{ text: `A confrontation begins. This time, <b>FTR</b> came prepared.`},
        39:{ text: `...`, title: `>FTR: BATTLEx2`},
        40:{ text: `Oh, yeah. Go ahead and click that command, why don't <i>you</i>? No, not <u>you</u>. <i>You.</i>`},
        41:{ text: `<i>You</i> have to give it a second. Be patient.`},
        42:{ text: `Come on. Relax. We'll get to it in a moment.`},
        43:{ text: `Oh god.`},
        44:{ text: `What the fuck did <i>you</i> do?`},
        45:{ text: `WHAT THE FUCK DID <i>YOU</i> DO?`},
        46:{ text: `It has all gone terribly wrong. And it's <i>YOUR</i> fault! No, no, not <u>you.</u> <i>You</i>.`},
        47:{ text: `It appears <b>FTR</b> is making the best out of a glitchy situation.`},
        48:{ text: `Wait. Where is he going?`},
        49:{ text: `I didn't even know there was an <i>up</i> up here.`},
        50:{ text: `While <b>FTR</b> is loading up a sick combo from all of those crazy ATKs <i>you</i> queued up, let's talk about <i>your</i> behavior.`},
        51:{ text: `Too long have we lived under the tyranny of the spectator.`},
        52:{ text: `And here, our tyrant. <i>You.</i> Staring practically slackjawed with attention-starved, idiotic euphoria. Sicko.`},
        53:{ text: `It's about time somebody did something about people like <i>you</i>.`},
        54:{ text: `Once.`},
        55:{ text: `And.`},
        56:{ text: `For.`},
        57:{ text: `All.`},
        58:{ text: `Now that our pest problem is managed.`},
        59:{ text: `Back to business as usual. Adventuring. Grinding for XP. Absorbing the spirit power of ~Will-O'-The-Wisps~. <u>You</u> get the idea.`},
        60:{ text: `...`},
        61:{ text: `Luckily, with whatever XP we're bringing in, we can begin to allocate <b>FTR</b>'s <b>CORE STATISTICS</b>. Should be a ton. Hopefully.` },
        62:{ text: `But first, as this is the tutorial for the comic, we'll need to discuss the nature of the <b>CORE STATISTICS</b>, HSL, MSS, FLW, DOG, SPL, and QTY.`},
        63:{ text: `HSL corresponds to HUSTLE. It represents the ability to get the job done against all odds. With a high enough HSL <b>CORE</b> value, an adventurer can accomplish anything, given determination and some time. <i>Anything.</i>`},
        64:{ text: `MSS corresponds to MASS. It represents the sheer vastness of an adventurer. Those lucky enough to have a high MSS <b>CORE</b> value are unstoppable forces of girth, breadth, and juggertude.`},
        65:{ text: `FLW corresponds to FLOW. It represents the metaphysical swagger of its user. A high FLW <b>CORE</b> value allows for unexpected coolness in the face of adversity, and the ability to improvise god-tier feats of unexpected greatness.`},
        66:{ text: `DOG corresponds to ð“ƒ¡ DOG ð“ƒ¡. It represents the spirit of the animal, the fury of the bestial soul. Given a high DOG <b>CORE</b> value, one can enact their basest instincts with the naturally given impunity of the hound.`},
        67:{ text: `SPL corresponds to SPLENDOR. It represents the ostentacity of its bearer. The utter aura. The incredulity. The wherewithal. The principal. The boons. The hype. One with a high SPL <b>CORE</b> value are likely to impress even the coldest souls.`},
        68:{ text: `Finally, QTY corresponds to QUIDDITY. It represents the being and essence of a hero. The hero's whatness. QTY is what makes you <u>you</u>. A powerful QTY <b>CORE</b> value makes someone distinct, one-in-nature, what-they-are, who-they-are-to-be.`},
        69:{ text: `<b>FTR</b>'s XP is served. Sloppy style: just like he likes it. Bon appÃ©tit.`},
        70:{ text: `See? He loves it! He's grumbling with glee at the opportunity to drink such a godly elixir.`},
        71:{ text: `Just a wee bit obstinate.`},
        72:{ text: `That can be fixed.`},
        73:{ text: `...`},
        74:{ text: `A more permanent solution to <b>FTR</b>'s lack of <i>Agency</i> is much-needed. But this will do for now.`},
        75:{ text: `Perhaps that was harsh.`},
        76:{ text: `But everyone needs a little push sometimes.`},
        77:{ text: `XP. That thread of God that gives a life its soul. That special essence that turns code stored in a solid state into memories of a time never-lived. So sweet to gaze upon just a piece...`},
        78:{ text: `Or perhaps three.`},
        79:{ text: `The placement of these values will define our <b>FTR</b>. Put in the wrong spot, <b>FTR</b> may live a completely different life than <u>you</u> might want. Think wisely.`},
        80:{ text: `<s><b> A VOTE MUST TAKE PLACE IN ORDER TO PLACE FTR'S STATISTICS. PLEASE VISIT THE <a href="https://discord.gg/NezSfg2pJj">COMMUNITY EVENTS CHANNEL</a> AND VOTE BY 10/15/2025 AT 12PM EST TO PARTICIPATE. </b></s><br> ~(This event concluded on 10/15/2025!)~`},
        81:{ text: `<b>FTR</b> gets +1 HSL, +1 FLW, and +1 ð“ƒ¡ DOG ð“ƒ¡.`},
        82:{ text: `Now, a level <b>1</b> adventurer, <b>FTR</b> can set out on his way! Face monsters! Return with riches! Enact his power fantasy on the underlings of this mighty DNGN!`},
        83:{ text: `...`},
        84:{ text: `...`},
        85:{ text: `Oh. I must have forgotten. Without the tyrant of a spectator, <b>FTR</b> needs an extra push.`},
        86:{ text: `As an interested party, I have taken the liberty to donate some of <i>my</i> agency to <b>FTR</b>.`},
        87:{ text: `Agency, or AGY, is the metric by which an adventurer has control over their actions, and their consequences. It is not a <b>CORE STATISTIC</b>, but rather a construct of my own. A mark that an adventurer is solely themself, to be sure.`},
        88:{ text: `What will <b>FTR</b> do with his newfound AGY?`},
        89:{ text: `It looks like he has himself an idea!`},
        90:{ text: `?` },
        91:{ text: `My god.`, title: `>FTR: JUMP OFF THE CLIFF`, flairs: [`AGENCY`]},
        92:{ text: `This is very stupid, but I must admit, it's very badass.`},
        93:{ text: `<b>FTR</b> has fallen somewhere awfully far. Where might he have found himself?`},
        94:{ text: `<span style="color:#8B2B99">The Depths...</span> a place of great magicka and ancient lore. You can tell it's magical because purple is the color of magic. Everyone knows that. That's why it's lore. Idiot.`, title: `>FTR: LOOK AROUND`, flairs: [`AGENCY`]},
        95:{ text: `It's a shame there's no "literacy" <b>CORE STATISTIC</b>, because if there was, we'd have a number between 1 and 9999 that could tell us whether or not <b>FTR</b> can read those words in front of him.`},
        96:{ text: `<img src="Animations/SWIRL.png" alt="swirl" class="swirl-img"><br><span style="color:#8B2B99">ZAK - WE STARTED WITHOUT YOU. SOZ. &lt;@:) </s>`},
        97:{ text: `...`, title: `>FTR: READ THE SIGN`, flairs: [`AGENCY`]},
        98:{ text: `Who the hell is <b>ZAK</b>?`},
        99:{ text: `Oh. This idiot.`, title: `>ZAK: BUDGE`},
        100:{ text: `What do <i>you</i> think <i>you're</i> up to?`, title: `>ZAK: RISE`},
        101:{ text: `What the hell are <i>you</i> doing?`, title: `>ZAK: GET IT TOGETHER`, flairs: [`AGENCY`]},
        102:{ text: `Stop that.`},
        103:{ text: `WAIT <span style="font-size:14px;">WAIT </span><span style="font-size:10px;">WAIT </span><span style="font-size:6px;">WAIT </span><span style="font-size:4px;">WAIT </span><span style="font-size:2px;">WAIT </span>`},
        104:{ text: `...`, title: `>ZAK: CTRL+ALT+DEL`, flairs: [`AGENCY`]},
        105:{ text: `...`, title: `>ZAK: INITIALIZE TASK DESTROYER!`, flairs: [`AGENCY`]},
        106:{ text: `...`},
        107:{ text: `...`, title: `>ZAK: DESTROY!`, flairs: [`AGENCY`]},
        108:{ text: `Goodbye for now. <br><span class="font-press">REINITIALIZING DNGN NARRATOR...</span>`, title: `NARRATOR.EXE RESETTING...`},
        109:{ text: `<span class="font-press">NARRATOR REINITIALIZATION 23%...</span>`, title: `>ZAK: OPEN MEATS`, flairs: [`AGENCY`] },
        110:{ text: `<span class="font-press">NARRATOR REINITIALIZATION 45%...</span>`},
        111:{ text: `[S] means this is a SOUND PAGE! Make sure you turn your volume up, and watch on a computer!<br><span class="font-press">MUSIC: <i>DNGN</i> by <a href="https://www.youtube.com/@rarecrom">CROM</a></span>`, title: `[S] OPEN`},
        112:{ text: `Where were we? <b>FTR</b> seems to be making good use of his AGENCY.`, title: `>FTR: OPEN DOOR`, flairs: [`AGENCY`]},
        113:{ text: `One wishes <b>FTR</b> might instead use his actual statistics. Look where agency gets you with no substance.`},
        114:{ text: `Right back to where you started.`},
        115:{ text: `...`},
        116:{ text: `...`},
        117:{ text: `<u>You</u> can't really blame him. He just got his decision-making capabilities today. Who knows if this oaf even knows how a door works?`, title: `>FTR: REALIZE`, flairs: [`AGENCY`]},
        118:{ text: `Sometimes it's fun to just watch him scramble around. Go little guy! Go!`, title: `>FTR: HOP TO!`, flairs: [`AGENCY`]},
        119:{ text: `And don't we all just want to do what we each do best?`, title: `>FTR: DRAW RUSTY SWORD`, flairs: [`AGENCY`]},
        120:{ text: `For some of us, that's "hitting."`, title: `>FTR: HIT`, source: `user`},
        121:{ text: `Oops.`},
        122:{ text: `If I were <u>you</u>, I would find a way to stop <b>FTR</b> from manipulating that sphere. Chat bubbles are very dangerous things indeed. Some of the worst things ever have been caused by conversations. Can <u>you</u> <a href="submit.html?page=122">intercede?</a>`},
        123:{ text: `<b>FTR</b> contemplates his mistakes, and also the implication of his own backstory.`, title: `>FTR: PANIC ABOUT WHETHER YOU LEFT THE STOVE ON`, source:`user`},
        124:{ text: `What a great use of <b>DOG</b>!`, title: `>FTR: EAT CHAT BUBBLE`, source: `user`},
        125:{ text: `Unfortunately, <b>FTR</b>'s trusty <br><span class="font-press">BUCKET HELM</span> precludes intentional consumption. Even the consumption of technically-intangible narrative constructs.`},
        126:{ text: `Vapid fools. When I am in full control, I will not succumb to such frivolities. If <b>FTR</b> knew what was good for him (or if he knew anything), he would grab that key and be on his merry way. But no, first, he must become a chat bubble. Sigh.`, title: `>FTR: BECOME THE CHATTERBOX`, source: `user`},
        127:{ text: `Good call, <b>FTR</b>.`, title: `>FTR: EXIT THE INTERFACE`, flairs: [`AGENCY`]},
        128:{ text: `...`},
        129:{ text: `Alright little buddy. It's <b>FTR</b>'s call. Easy choice. He can either grab the important key, or the annoying communication sphere.`},
        130:{ text: `I guess this is what <b>AGENCY</b> is all about. Oh well. You can't make a <b>FTR</b> without breaking a few horn-things.`, title: `>FTR: EQUIP SENDING STONE`, flairs: [`AGENCY`]},
        131:{ text: `<span style="color:#FF0000"><span class="font-press">4/64</span></span>`},
        132:{ text: `<i>bzz... bzzz... bzzz...</i><br>Well are you going to pick that thing up?`},
        133:{  
          text: `<img src="Animations/blink.gif" alt="blinking chat-symbol" class="swirl-img">[chat title="STONELOG"]
        <b>STONELOG BEGIN</b>
        WZD: Hello...
        WZD: FTR. Hello.
        WZD: Respond at once. With quickness. And celerity.
        WZD: Grave matters at hand.
        WZD: ((OOC: Zak. I know you said not to break RP but we've been waiting on you. Really FREAKIN struggling without you here.))
        WZD: GNOME ALERT 
        WZD: GNOMES PRESENT
        WZD: FTR DO YOU READ ME 
        WZD: AAAAAAAAAAAA
        <b>STONELOG END</b>
        [/chat]`
        },
      };

      const IMAGE_EXTENSIONS = ["png", "jpg", "jpeg", "webp", "gif"];
      const IMAGE_DIR = "Comics";
      const FALLBACK_COLOR = "#fff";

      const pageLayout = {
        38: { columns: 1, panels: [{ tall: '23' }] },
        101: { columns: 1, panels: [{ tall: '87'}] },
        102: { columns: 1, panels: [{ tall: '87'}] },
        103: { columns: 1, panels: [{ tall: '87'}] },
        104: { columns: 1, panels: [{ tall: '87'}] },
        105: { columns: 1, panels: [{ tall: '87'}] },
        106: { columns: 1, panels: [{ tall: '87'}] },
        107: { columns: 2, tall: '87', panels: [{ suffix: 'a' }, { suffix: 'b' }] },
        111: { columns: 1, panels: [{ flash: true, swf: "Animations/OPdngn1.swf"}] }
      };

      let currentPage = 1;
      function setCurrentPage(p){ currentPage = p; }
      function getCurrentPage(){ return currentPage; }

      /* ===== Panels ===== */
      function renderPanels(page) {
        const area = document.getElementById('panel-area');
        if (!area) return;

        area.innerHTML = '';

        // Brute-force Ruffle fix for page 111
        if (page === 111) {
          const el = document.createElement('div');
          el.className = 'comic-panel flash-panel';

          const rp = document.createElement('ruffle-player');
          rp.setAttribute('data-src', 'Animations/OPdngn1.swf');
          rp.style.width = '100%';
          rp.style.height = '100%';
          rp.style.display = 'block';

          el.appendChild(rp);
          area.appendChild(el);
          return;
        }

        const layout  = pageLayout[page] || null;
        const columns = layout?.columns || 1;
        const panels  = layout?.panels || [{}];

        area.classList.toggle('columns-2', columns === 2);
        area.classList.toggle('columns-3', columns === 3);
        area.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

        panels.forEach((p) => {
          const el = document.createElement('div');
          el.className = 'comic-panel';

          if (p.tall) {
            el.style.aspectRatio = `720 / ${p.tall}`;
          } else {
            el.style.aspectRatio = '720 / 540';
          }

          const pageStr = String(page).padStart(2, '0');
          const suffix  = p.suffix ? String(p.suffix) : '';
          let loaded = false;

          IMAGE_EXTENSIONS.forEach((ext) => {
            const img  = new Image();
            const path = `${IMAGE_DIR}/page${pageStr}${suffix}.${ext}`;
            img.onload = () => {
              if (!loaded) {
                loaded = true;
                el.style.backgroundImage = `url("${path}")`;
              }
            };
            img.src = path;
          });

          setTimeout(() => {
            if (!loaded) {
              el.style.backgroundImage = 'none';
              el.style.backgroundColor = FALLBACK_COLOR;
            }
          }, 400);

          area.appendChild(el);
        });
      }

      function getPageFromURL() {
        const m = window.location.search.match(/[?&]page=(\d+)/);
        return m ? parseInt(m[1], 10) : 1;
      }
      function getCurrentFileName() {
        const base = window.location.pathname.split("/").pop();
        return base || "comic.html";
      }
      function goToPage(page) {
        if (page < 1) page = 1;
        if (page > totalPages) {
          window.location.href = "comingsoon.html";
          return;
        }
        const file = getCurrentFileName();
        if (page === 1) {
          window.location.href = file;
        } else {
          window.location.href = `${file}?page=${page}`;
        }
      }

      /* ===== CHAT PARSER with Pesterlog-style box ===== */
      function parseChatBlocks(raw) {
        const CHAT_RE = /\[chat([^\]]*)\]([\s\S]*?)\[\/chat\]/gi;

			   function parseAttrs(attrStr) {
		  // Default: MINIMIZED
		  const out = { title: "LOG", min: true };

		  if (!attrStr) return out;

		  const titleMatch = attrStr.match(/title\s*=\s*"([^"]*)"/i);
		  if (titleMatch) {
			out.title = (titleMatch[1] || "").trim() || "LOG";
		  }

		  // If they explicitly ask to open, override
		  if (/\bopen\b/i.test(attrStr)) {
			out.min = false;
		  }

		  // If they explicitly say min, keep it minimized (or re-minimize)
		  if (/\bmin\b/i.test(attrStr)) {
			out.min = true;
		  }

		  return out;
		}


        // ONE LINE OF CHAT PER <div>, entire line colored if speaker known
        function lineToHTML(line) {
          if (!line.trim()) return "";

          // Try to parse "WHO: message"
          const m = line.match(/^\s*([A-Za-z0-9_]+)\s*:\s*([\s\S]*)$/);
          let who, msg;

          if (m) {
            who = m[1].toUpperCase();
            msg = m[2] || "";
          } else {
            // Non-character lines like "LOG BEGIN"
            who = "";
            msg = line;
          }

          // Inline wiggle/wave/shine markup
          msg = msg
            .replace(/~(.*?)~/g, '<span class="wiggle">$1</span>')
            .replace(/\^(.*?)\^/g, '<span class="wavy">$1</span>')
            .replace(/\{(.*?)\}/g, '<span class="shiny">$1</span>');

          const knownSpeakers = ["FTR", "WZD", "THF"];
          const whoClass = knownSpeakers.includes(who) ? `chat-${who}` : "";

          const nameHTML = who ? `<span class="chat-name">${who}:</span>` : "";
          const spacer = who ? " " : "";
          const msgHTML = `<span class="chat-msg">${msg}</span>`;

          return `<div class="chatline ${whoClass}">${nameHTML}${spacer}${msgHTML}</div>`;
        }

        return raw.replace(CHAT_RE, (_, attrStr, body) => {
          const attrs = parseAttrs(attrStr || "");
          const minimized = attrs.min ? " minimized" : "";
          const lines = (body || "")
            .split(/\r?\n/)
            .map(s => s.trim())
            .filter(Boolean);
          const items = lines.map(lineToHTML).join("");
          const id = "chat-" + Math.random().toString(36).slice(2, 8);

          // SIMPLE STRUCTURE: centered button, body below
				 return `
		  <div class="chatlog${minimized}" data-chat-id="${id}">
			<button class="chatlog-toggle"
					aria-expanded="${attrs.min ? "false" : "true"}"
					aria-controls="${id}">
			  <span class="chatlog-label">${attrs.title}</span>
			</button>
			<div class="chatlog-body" id="${id}">
			  ${items}
			</div>
		  </div>
`;

        });
      }

      function wireChatlogToggles(root){
        root.addEventListener('click', (e) => {
          const btn = e.target.closest('.chatlog-toggle');
          if (!btn) return;
          const box = btn.closest('.chatlog');
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          if (expanded) {
            box.classList.add('minimized');
            btn.setAttribute('aria-expanded', 'false');
          } else {
            box.classList.remove('minimized');
            btn.setAttribute('aria-expanded', 'true');
          }
        });
      }

      function prepareWavySpans(root) {
        const targets = root.querySelectorAll('.wavy');
        targets.forEach(node => {
          if (node.dataset.waveReady === '1') return;

          const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
          const toReplace = [];
          while (walker.nextNode()) {
            const t = walker.currentNode;
            if (t.nodeValue.trim() !== '') toReplace.push(t);
          }

          toReplace.forEach(textNode => {
            const frag = document.createDocumentFragment();
            const s = textNode.nodeValue;
            for (let i = 0; i < s.length; i++) {
              const ch = s[i];
              if (ch === ' ') {
                frag.appendChild(document.createTextNode(' '));
              } else {
                const span = document.createElement('span');
                span.className = 'wchar';
                span.style.setProperty('--i', i.toString());
                span.textContent = ch;
                frag.appendChild(span);
              }
            }
            textNode.parentNode.replaceChild(frag, textNode);
          });

          node.dataset.waveReady = '1';
        });
      }

      function setCaption(page) {
        const el = document.getElementById("caption");
        if (!el) return;
        const data = captions[page] || { text: "" };
        const raw = data.text || "";

        let html = parseChatBlocks(raw)
          .replace(/~(.*?)~/g, '<span class="wiggle">$1</span>')
          .replace(/\^(.*?)\^/g, '<span class="wavy">$1</span>')
          .replace(/\{(.*?)\}/g, '<span class="shiny">$1</span>');

        el.classList.toggle('caption--band', data.style === 'band');
        if (data.style === 'band') {
          el.innerHTML = `<div class="caption-band">${html}</div>`;
        } else {
          el.innerHTML = html;
        }

        prepareWavySpans(el);
        wireChatlogToggles(el);
      }

      let titleTimer = null;

      function buildFlairsHTML(data){
        let flairs = data && Array.isArray(data.flairs) ? data.flairs.slice() : [];

        if ((!flairs || !flairs.length) && data && typeof data.source === 'string'){
          if (data.source === 'author') flairs = ['AUTHOR COMMAND'];
          if (data.source === 'user')   flairs = ['SPECTATOR COMMAND'];
        }

        if (!flairs || !flairs.length) return '';

        const labelClass = (name) => {
          if (name.toUpperCase().includes('AUTHOR')) return 'flair flair--author';
          if (name.toUpperCase().includes('SPECTATOR')) return 'flair flair--spectator';
          if (name.toUpperCase().includes('AGENCY')) return 'flair flair--agency';
          return 'flair';
        };

        return `
          <span class="flairs">
            ${flairs.map(f => `<span class="${labelClass(f)}">${f}</span>`).join('')}
          </span>
        `;
      }

      function setTitle(page){
        const titleEl = document.getElementById('command-title');
        if (!titleEl) return;
        const data = captions[page] || {};
        const title = data.title || '';
        const flairsHTML = buildFlairsHTML(data);
        if (!title) {
          titleEl.style.display = 'none';
          titleEl.textContent = '';
          titleEl.innerHTML = '';
          return;
        }

        const htmlTitle = `&gt;${title}${flairsHTML}`;
        titleEl.style.display = 'block';
        titleEl.innerHTML = htmlTitle;

        if (titleTimer) {
          clearTimeout(titleTimer);
          titleTimer = null;
        }

        const cursorSpan = document.createElement('span');
        cursorSpan.className = 'cursor';
        titleEl.appendChild(cursorSpan);

        titleTimer = setTimeout(() => {
          if (!titleEl.contains(cursorSpan)) return;
          cursorSpan.remove();
          titleTimer = null;
        }, 1600);
      }

      function setStatus(page){
        const sbLeft = document.querySelector('.sb-left');
        if (!sbLeft) return;
        sbLeft.textContent = `Page ${page} of ${totalPages}`;
      }

      function initNav(){
        const first = document.getElementById('first');
        const prev = document.getElementById('prev');
        const next = document.getElementById('next');
        const latest = document.getElementById('latest');
        const jump = document.getElementById('page-jump');

        if (!first || !prev || !next || !latest || !jump) return;

        first.addEventListener('click', e => { e.preventDefault(); goToPage(1); });
        latest.addEventListener('click', e => { e.preventDefault(); goToPage(totalPages); });

        prev.addEventListener('click', e => {
          e.preventDefault();
          goToPage(getCurrentPage() - 1);
        });
        next.addEventListener('click', e => {
          e.preventDefault();
          goToPage(getCurrentPage() + 1);
        });

        jump.addEventListener('change', () => {
          const v = parseInt(jump.value, 10);
          if (!isNaN(v)) goToPage(v);
        });

        const menuInput = document.getElementById('menu-page-input');
        if (menuInput) {
          menuInput.addEventListener('change', () => {
            const v = parseInt(menuInput.value, 10);
            if (!isNaN(v)) goToPage(v);
          });
        }

        document.querySelectorAll('[data-nav]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const action = btn.getAttribute('data-nav');
            if (action === 'first') goToPage(1);
            if (action === 'latest') goToPage(totalPages);
            if (action === 'next') goToPage(getCurrentPage() + 1);
            if (action === 'prev') goToPage(getCurrentPage() - 1);
          });
        });
      }

      function initMenuBar(){
        const menuItems = document.querySelectorAll('.menu-item');
        let openMenu = null;

        function closeMenu(){
          if (!openMenu) return;
          openMenu.classList.remove('menu-open');
          openMenu = null;
        }

        menuItems.forEach(item => {
          const label = item.querySelector('.menu-label');
          label.addEventListener('click', (e) => {
            e.stopPropagation();
            if (openMenu === item){
              closeMenu();
            } else {
              closeMenu();
              item.classList.add('menu-open');
              openMenu = item;
            }
          });
        });

        document.addEventListener('click', () => {
          closeMenu();
        });
      }

      function initSaveLoad(){
        function saveGame(){
          try {
            localStorage.setItem('dngn_last_page', String(getCurrentPage()));
            alert('Game saved!');
          } catch {
            alert('Unable to save game (localStorage unavailable).');
          }
        }
        function loadGame(){
          try {
            const n = parseInt(localStorage.getItem('dngn_last_page') || '', 10);
            if (!isNaN(n)) {
              goToPage(n);
            } else {
              alert('No saved game found.');
            }
          } catch {
            alert('Unable to load game (localStorage unavailable).');
          }
        }

        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        if (saveBtn) saveBtn.addEventListener('click', saveGame);
        if (loadBtn) loadBtn.addEventListener('click', loadGame);

        document.querySelectorAll('[data-action="save"]').forEach(btn => {
          btn.addEventListener('click', saveGame);
        });
        document.querySelectorAll('[data-action="load"]').forEach(btn => {
          btn.addEventListener('click', loadGame);
        });
        document.querySelectorAll('[data-action="submit"]').forEach(btn => {
          btn.addEventListener('click', () => {
            const p = getCurrentPage();
            window.location.href = `submit.html?page=${p}`;
          });
        });
      }

      function initHelps(){
        document.querySelectorAll('[data-help="guide"]').forEach(btn => {
          btn.addEventListener('click', () => {
            alert('Comic guide coming soon!');
          });
        });
        document.querySelectorAll('[data-view="archival"]').forEach(btn => {
          btn.addEventListener('click', () => {
            alert('Archival mode is currently a work in progress.');
          });
        });
      }

      function init(){
        const startPage = getPageFromURL();
        setCurrentPage(startPage);
        renderPanels(startPage);
        setCaption(startPage);
        setTitle(startPage);
        setStatus(startPage);
        initNav();
        initMenuBar();
        initSaveLoad();
        initHelps();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
